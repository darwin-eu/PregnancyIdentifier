---
title: "PregnancyIdentifier pipeline overview"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PregnancyIdentifier pipeline overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

This vignette describes the **PregnancyIdentifier** pipeline, which implements the HIPPS approach to identify pregnancy episodes in OMOP CDM data. The pipeline has four main algorithm components, run in sequence:

1. **HIP** — Outcome-anchored episode builder: identifies pregnancy episodes from high-specificity pregnancy outcomes and gestational-age evidence. See the [HIP vignette](hip.html).
2. **PPS** — Gestational-timing concept episode builder: constructs episodes from pregnancy-related concepts and expected timing windows. See the [PPS vignette](pps.html).
3. **Merge** — Combines HIP and PPS episodes into a unified per-person timeline (HIPPS) by temporal overlap and best-match deduplication. See the [Merge vignette](merge.html).
4. **ESD** — Episode start date refinement: uses gestational timing evidence (GW and GR3m) to infer pregnancy start dates and precision. See the [ESD vignette](esd.html).

At a high level, the pipeline (i) assembles pregnancy signals and outcomes from standard OMOP domains via `initPregnancies()`, (ii) builds outcome-anchored episodes (HIP) and timing-anchored episodes (PPS), (iii) merges them into HIPPS, (iv) refines episode start dates with ESD, and (v) optionally exports de-identified summary tables for QA and cross-site comparison.

## Running the full pipeline

The primary entry point is `runPregnancyIdentifier()`, which runs all steps end-to-end and writes intermediate artifacts and final outputs to `outputDir`.

```{r, eval=FALSE}
library(PregnancyIdentifier)
library(CDMConnector)

# A cdm_reference from CDMConnector (e.g. mock or real CDM)
cdm <- mockPregnancyCdm()

runPregnancyIdentifier(
  cdm           = cdm,
  outputDir     = "pregnancy_identifier_output",
  startDate     = as.Date("2000-01-01"),
  endDate       = Sys.Date(),
  justGestation = TRUE,
  minCellCount  = 5L
)
```

### Outputs written to disk

The pipeline writes intermediate RDS artifacts as it proceeds and finishes with a patient-level episode table plus optional shareable exports:

| File | Description |
|------|--------------|
| `runStart.csv` | Run timestamp |
| `log.txt` | Run log |
| `HIP_episodes.rds` | HIP episodes (outcome and/or gestation-derived) |
| `pps_gest_timing_episodes.rds` | PPS record-level episodes (concept rows with episode assignments) |
| `pps_min_max_episodes.rds` | PPS episode summaries (min/max dates per episode) |
| `PPS_episodes.rds` | PPS episodes with inferred outcomes (input to merge) |
| `HIPPS_episodes.rds` | Merged HIP + PPS episode table (standardized columns) |
| `ESD.rds` | (optional, `debugMode = TRUE`) ESD episode-level start inference |
| `final_pregnancy_episodes.rds` | **Final** episode table: one row per episode, with inferred start/end and outcomes |
| `export/` | De-identified summary CSVs and ZIP archive (if export step is used) |

## Pipeline steps in order

1. **initPregnancies** — Loads pregnancy concept sets into the CDM, builds `preg_hip_records` and `preg_pps_records` from condition, procedure, observation, and measurement tables within the study window.
2. **runHip** — Builds outcome episodes, then gestation episodes, merges and cleans them, and writes `HIP_episodes.rds`.
3. **runPps** — Builds PPS episodes from pregnancy-related concepts, assigns outcomes via lookback/lookahead, and writes `pps_gest_timing_episodes.rds`, `pps_min_max_episodes.rds`, and `PPS_episodes.rds`.
4. **mergeHipps** — Reads `HIP_episodes.rds` and `PPS_episodes.rds`, merges by temporal overlap, deduplicates many-to-many matches, and writes `HIPPS_episodes.rds`.
5. **runEsd** — Reads `HIPPS_episodes.rds`, pulls gestational timing concepts (GW/GR3m), infers start dates and precision, merges back to HIPPS metadata, and writes `final_pregnancy_episodes.rds`.
6. **exportPregnancies** — (Optional) Reads `final_pregnancy_episodes.rds` and writes shareable CSVs and a ZIP to `exportDir`.

## Interpreting the final episode table

The primary analysis dataset is `final_pregnancy_episodes.rds`, with one row per pregnancy episode. Key fields include:

- **Dates:** `inferred_episode_start`, `inferred_episode_end` (final inferred interval); `recorded_episode_start`, `recorded_episode_end` (evidence window); `hip_end_date`, `pps_end_date` (algorithm-specific end dates when available).
- **Outcome:** `final_outcome_category` (harmonized); `hip_outcome_category`, `pps_outcome_category` (component algorithm categories).
- **Timing:** `precision_days`, `precision_category`; `gestational_age_days_calculated`; `term_duration_flag` and related QA/concordance fields.

For details on each algorithm step, see the dedicated vignettes: [HIP](hip.html), [PPS](pps.html), [Merge](merge.html), and [ESD](esd.html).
